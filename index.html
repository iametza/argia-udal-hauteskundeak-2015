<!doctype html>

<html>
	<head>
		<title>Euskal Herria - udalerriak</title>
		<style>
			.unitateak {
				fill: #DDDDCC;
			}

			.unitateak:hover {
				fill: #FFFF00
			}

			.eskualde-mugak {
				fill: none;
				stroke: #777;
				/*stroke-dasharray: 2,2;*/
				stroke-width: 0.5px;
				stroke-linejoin: round;
			}

			.kanpo-mugak {
				fill: none;
				stroke: #777;
				stroke-width: 2px;
				stroke-linejoin: round;
			}

			#kontainerra {
				margin: 0 auto 0 auto;
				width: 1000px;
				position: relative;
			}

			#mapa {
				display: inline-block;
				position: absolute;
			}

			#datuak {
				left: 700px;
			    position: absolute;
			    top: 135px;
			}

			#datuak table {
			    border-collapse: collapse;
			}

			#datuak td, #datuak th {
			    border: 1px solid #999;
			    padding: 0.5rem;
			    text-align: left;
			}

			#unitatea-izena {
				font-size: 20px;
			    font-weight: bold;
			    left: 740px;
			    position: absolute;
			    text-align: center;
			    top: 60px;
			}

			#barrak {
				display: inline-block;
			    left: 600px;
			    position: absolute;
			    top: 330px;
			}

			#logo-ehbildu {
			    left: 613px;
			    position: absolute;
			    top: 531px;
			    width: 48px;
			}

			#logo-eaj-pnv {
				left: 691px;
			    position: absolute;
			    top: 534px;
			    width: 48px;
			}

			#logo-pse-ee {
				left: 769px;
			    position: absolute;
			    top: 537px;
			    width: 38px;
			}

			#logo-pp {
				left: 844px;
				position: absolute;
				top: 537px;
				width: 38px;
			}

		</style>
	</head>

	<body>
		<div id="kontainerra">
			<div id="unitatea-izena"></div>
			<div id="mapa"></div>
			<div id="barrak"></div>
			<img id="logo-ehbildu" src="img/ehbildu.jpg" />
			<img id="logo-eaj-pnv" src="img/eaj-pnv.png" />
			<img id="logo-pse-ee" src="img/pse-ee.gif" />
			<img id="logo-pp" src="img/pp.png" />
			<div id="datuak">
				<table>
					<tr>
						<td>&nbsp;</td>
						<td>2007</td>
						<td>2011</td>
					</tr>
					<tr>
						<td>EH Bildu</td>
						<td id="ehbildu-1"></td>
						<td id="ehbildu-2"></td>
					</tr>
					<tr>
						<td>EAJ-PNV</td>
						<td id="eaj-pnv-1"></td>
						<td id="eaj-pnv-2"></td>
					</tr>
					<tr>
						<td>PSE-EE</td>
						<td id="pse-ee-1"></td>
						<td id="pse-ee-2"></td>
					</tr>
					<tr>
						<td>PP</td>
						<td id="pp-1"></td>
						<td id="pp-2"></td>
					</tr>
				</table>
		</div>

		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>

		<script>
			var width = 700,
				height = 600;

			var projection = d3.geo.mercator()
				.center([-2.2,43.15])
				.scale(42000)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("#mapa").append("svg")
				.attr("width", width)
				.attr("height", height);

			var herrialde_kodeak = {
				//"BIZKAIA": ,
				"GIPUZKOA": 20
			}

			var koloreak = ["#5DA5DA", "#FAA43A"];

			var aurreko_y = [];

			d3.csv("datuak/MunJ07_c.csv", function(emaitzak1) {

				d3.csv("datuak/MunJ11_e.csv", function(emaitzak2) {

					//console.log(emaitzak2);

					d3.json("udalerriak-gipuzkoa.json", function(error, eh) {

						if (error) return console.error(error);

						//console.log(eh);

						//console.log(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features);

						// Emaitzak eta topoJSON-a bateratzeko ideia hemendik hartu dut, behar bada badago modu hobe bat.
						// http://stackoverflow.com/questions/22994316/how-to-reference-csv-alongside-geojson-for-d3-rollover

						//console.log(emaitzak1);

						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak1.forEach(function(d, i) {

							if (d["TH"] === "GIPUZKOA") {

								//console.log(herrialde_kodeak[d["TH"]] + d["Cod.Municipio"]);

								// e: Object { type="Feature",  properties={...},  geometry={...}}
								// j. indizea
								topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features.forEach(function(e, j) {
									//console.log(e.properties.ud_kodea);
									//console.log(j);
						            if (herrialde_kodeak[d["TH"]] + d["Cod.Municipio"] === e.properties.ud_kodea) {
						                e.properties.emaitzak1 = d;
						            }
						        });

							}

					    });

						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak2.forEach(function(d, i) {

							if (d["TH"] === "GIPUZKOA") {

								//console.log(herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"]);

								// e: Object { type="Feature",  properties={...},  geometry={...}}
								// j. indizea
								topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features.forEach(function(e, j) {
									//console.log(e.properties.ud_kodea);
									//console.log(j);
						            if (herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"] === e.properties.ud_kodea) {
						                e.properties.emaitzak2 = d;
						            }
						        });

							}

					    });

						svg.selectAll(".unitateak")
							.data(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features)
							.enter().append("path")
							.attr("class", "unitateak")
							.attr("id", function(d) { return "unitatea_" + d.properties.ad_kod; })
							.attr("d", path)
							.on("mouseover", function(d) {
								//console.log(d);
								d3.select("#unitatea-izena").text(d.properties.iz_euskal);
								marraztuBarrak(d.properties.emaitzak1, d.properties.emaitzak2);
								beteTaula(d.properties.emaitzak1, d.properties.emaitzak2);
							});

						// Eskualdeen arteko mugak (a !== b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a !== b; }))
							.attr("d", path)
							.attr("class", "eskualde-mugak");

						// Kanpo-mugak (a === b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a === b; }))
							.attr("d", path)
							.attr("class", "kanpo-mugak");

					});

				});

			});

			function marraztuBarrak(datuak1, datuak2) {

				d3.select("#barrak svg").remove();

				var zabalera = 300;
				var altuera = 200;
				var barPadding = 10;

				var barrak = d3.select('#barrak')
							   .append("svg")
							   .attr("width", zabalera)
							   .attr("height", altuera);

				var emaitzak = [{
						alderdia: "EAE / ANV (Nuluak)",
						botoak: parseInt(datuak1["Nulos"], 10)
					}, {
						alderdia: "BILDU",
						botoak: parseInt(datuak2["BILDU"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak1["EAJ-PNV"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak2["EAJ-PNV"], 10)
				    }, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak1["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak2["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak1["PP"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak2["PP"], 10)
					}
				];

				var barra_kopurua = emaitzak.length;

				var barra_zabalera = zabalera / barra_kopurua;

				var altueraEskala = d3.scale.linear()
									.domain([0,
										 	 d3.max(emaitzak,
													function(d) {
														return d.botoak;
													})
									])
									.range([altuera, 0]);

				barrak.selectAll("rect")
			   		  .data(emaitzak)
			   		  .enter()
				      .append("rect")
					  .attr("x", function(d, i) {
						  var x = i * barra_zabalera;

						  if (i % 2 === 0) {
							  x = x + barPadding;
						  }
					      return x;
					  })
				      .attr("y", function(d, i) {
						  if (aurreko_y[i]) {
							  return aurreko_y[i];
						  }
						  return 0;
					  })
				      .attr("width", barra_zabalera - barPadding)
					  .attr("height", altuera)
					  .attr("fill", function(d, i) {
						  return koloreak[i % 2];
					  })
					  .transition()
      				  .delay(function(d, i) { return i * 100; })
					  .duration(300)
					  .attr("y", function(d, i) {
						  aurreko_y[i] = altueraEskala(d.botoak);
						  return altueraEskala(d.botoak);
					  })
					  .attr("height", function(d, i) {
					      return altuera - altueraEskala(d.botoak);
					  });


				/*barrak.selectAll("text")
					  .data(emaitzak)
					  .enter()
					  .append("text")
			      	  .attr("x", function(d, i) {
					      return i * zabalera / barra_kopurua;
					  })
			      	  .attr("y", 0)
			      	  .attr("dy", ".75em")
			       	  .text(function(d) { return d.alderdia; });
				*/
			}

			function beteTaula(datuak1, datuak2) {

				var emaitzak = [{
						alderdia: "EAE / ANV (Nuluak)",
						botoak: parseInt(datuak1["Nulos"], 10)
					}, {
						alderdia: "BILDU",
						botoak: parseInt(datuak2["BILDU"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak1["EAJ-PNV"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak2["EAJ-PNV"], 10)
				    }, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak1["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak2["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak1["PP"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak2["PP"], 10)
					}
				];

				d3.select("#ehbildu-1").text(emaitzak[0].botoak);
				d3.select("#ehbildu-2").text(emaitzak[1].botoak);

				d3.select("#eaj-pnv-1").text(emaitzak[2].botoak);
				d3.select("#eaj-pnv-2").text(emaitzak[3].botoak);

				d3.select("#pse-ee-1").text(emaitzak[4].botoak);
				d3.select("#pse-ee-2").text(emaitzak[5].botoak);

				d3.select("#pp-1").text(emaitzak[6].botoak);
				d3.select("#pp-2").text(emaitzak[7].botoak);
			}
		</script>
	</body>
</html>
