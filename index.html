<!doctype html>

<html>
	<head>
		<meta charset="utf-8">
		<title>Euskal Herria - udalerriak</title>
		<style>
			.unitateak {
				/*fill: #DDDDCC;*/
			}

			.unitateak:hover {
				/*stroke: #000000;
				stroke-width: 1.5px;*/
				fill: #777;
			}

			.eskualde-mugak {
				fill: none;
				stroke: #777;
				/*stroke-dasharray: 2,2;*/
				stroke-width: 0.5px;
				stroke-linejoin: round;
			}

			.kanpo-mugak {
				fill: none;
				stroke: #777;
				stroke-width: 2px;
				stroke-linejoin: round;
			}

			#kontainerra {
				margin: 0 auto 0 auto;
				width: 680px;
				position: relative;
				border: 1px solid black;
				height: 800px;
				font-family: Arial,Helvetica,sans-serif !important;
				font-size: 16px;
			}

			#mapa {
				border: 1px solid black;
				display: block;
				margin-left: auto;
				margin-right: auto;
			}
			
			.datuak {
				width: 580px;
				margin-left: auto;
				margin-right: auto;
			}
			
			#unitatea-izena {
				font-size: 20px;
				font-weight: bold;
				text-align: center;
				margin-bottom: 10px;
				margin-top: 10px;
			}
			
			.datuak-taula {
				float: left;
				margin-left: 75px;
			}
			
			.datuak-taula .eskuinekoa {
				text-align: right;
			}
			
			.emaitzak-taula {
				float: right;
				margin-right: 50px;
			}
			
			.emaitzak-taula .izena {
				
			}
			
			.emaitzak-taula .botoak {
				text-align: right;
				width: 60px;
			}
			
			.emaitzak-taula .ahulkiak {
				text-align: right;
				width: 30px;
			}
			
			.emaitzak-taula .aldea {
				text-align: right;
				width: 50px;
			}

		</style>
	</head>

	<body>
		<div id="kontainerra">
			<div id="mapa"></div>
			<div class="datuak">
				<div id="unitatea-izena"></div>
				<table class="datuak-taula">
					<tr>
						<td>Ordua</td>
						<td class="eguneraketa-ordua eskuinekoa"></td>
					</tr>
					<tr>
						<td>Zenbatua</td>
						<td class="zenbatua eskuinekoa"></td>
					</tr>
					<tr>
						<td>Errolda</td>
						<td class="errolda eskuinekoa"></td>
					</tr>
					<tr>
						<td>Abstentzioa</td>
						<td class="ehuneko-abstentzioa eskuinekoa"></td>
					</tr>
					<tr>
						<td>Baliogabeak</td>
						<td class="ehuneko-baliogabeak eskuinekoa"></td>
					</tr>
					<tr>
						<td>Zuriak</td>
						<td class="ehuneko-zuriak eskuinekoa"></td>
					</tr>
				</table>
				<table class="emaitzak-taula"></table>
			</div>
		</div>

		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
		
		<script>
			
			var alderdiak = {
                "EH BILDU": {
					kolorea: "#b3c801",
                    irudia: "img/ehbildu.jpg"
                },
                "EAJ-PNV": {
                    kolorea: "#008336",
					irudia: "img/eaj-pnv.png"
                },
                "PSE-EE": {
					kolorea: "#ed1b24",
                    irudia: "img/pse-ee.gif"
                },
                "PP": {
					kolorea: "#0BB2FF",
                    irudia: "img/pp.png"
                },
				"UPYD": {
					kolorea: "#E4007D",
					irudia: "img/upyd.png"
				},
				"CIUDADANOS": {
					kolorea: "#F78934",
					irudia: "img/ciudadanos.jpg"
				},
				"PODEMOS": {
					kolorea: "#6B1F5F",
					irudia: "img/podemos.png"
				},
				"IRABAZI": {
					kolorea: "#4B4B49",
					irudia: "img/irabazi.png"
				},
				"GEROA BAI": {
					kolorea: "#D42E12",
					irudia: "img/geroabai.jpg"
				},
				"UPN": {
					kolorea: "#0C4DA2",
					irudia: "img/upn.png"
				},
				"PSN": {
					kolorea: "#ed1b24",
					irudia: "img/psn.png"
				},
				"RCN-NOK": {
					irudia: "img/rcn-nok.png"
				},
				"I-E": {
					irudia: "img/ezkerra.jpg"
				},
				"SAIn": {
					irudia: "img/sain.png"
				},
				"PACMA": {
					irudia: "img/pacma.jpeg"
				},
				"LN": {
					irudia: "img/ln.png"
				},
				"EQUO": {
					irudia: "img/equo.jpeg"
				},
				"IKUNE": {
					irudia: "img/ikune.png"
				},
				"VOX": {
					irudia: "img/vox.jpg"
				}
            }
            
			var herrialdeak = {
				"gipuzkoa": {
					kodea: 20,
					datuakJSON_1: "datuak/gipuzkoa-udalak-2011.json",
					datuakJSON_2: "datuak/gipuzkoa-udalak-2015.json",
					json_izena: "udalerriak-gipuzkoa",
					topoJSON: "topoJSON/udalerriak-gipuzkoa.json",
					proiekzioa: {
						erdia: {
							lat: -2.165,
							lng: 43.15
						},
						eskala: 43500
					},
					altuera: 535,
					zabalera: 680

				},
				"bizkaia": {
					kodea: 48,
					datuakJSON_1: "datuak/bizkaia-udalak-2011.json",
					datuakJSON_2: "datuak/bizkaia-udalak-2015.json",
					json_izena: "udalerriak-bizkaia",
					topoJSON: "topoJSON/udalerriak-bizkaia.json",
					proiekzioa: {
						erdia: {
							lat: -2.93,
							lng: 43.22
						},
						eskala: 37000
					},
					altuera: 430,
					zabalera: 680
				},
				"araba": {
					kodea: "01",
					datuakJSON_1: "datuak/araba-udalak-2011.json",
					datuakJSON_2: "datuak/araba-udalak-2015.json",
					json_izena: "udalerriak-araba",
					topoJSON: "topoJSON/udalerriak-araba.json",
					proiekzioa: {
						erdia: {
							lat: -2.75,
							lng: 42.85
						},
						eskala: 33000
					},
					altuera: 600,
					zabalera: 680
				},
				"nafarroa": {
					kodea: "31",
					datuakJSON_1: "datuak/nafarroa-udalak-2011.json",
					datuakJSON_2: "datuak/nafarroa-udalak-2015.json",
					json_izena: "udalerriak-nafarroa",
					topoJSON: "topoJSON/udalerriak-nafarroa.json",
					proiekzioa: {
						erdia: {
							lat: -1.615,
							lng: 42.61
						},
						eskala: 19000
					},
					altuera: 650,
					zabalera: 680
				}
			}

			var hautatutako_herrialdea = "nafarroa";

			var width = herrialdeak[hautatutako_herrialdea].zabalera,
				height = herrialdeak[hautatutako_herrialdea].altuera;

			var projection = d3.geo.mercator()
				.center([herrialdeak[hautatutako_herrialdea].proiekzioa.erdia.lat, herrialdeak[hautatutako_herrialdea].proiekzioa.erdia.lng])
				.scale(herrialdeak[hautatutako_herrialdea].proiekzioa.eskala)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("#mapa").append("svg")
				.attr("width", width)
				.attr("height", height);

			d3.json(herrialdeak[hautatutako_herrialdea].datuakJSON_1, function(error, emaitzak1) {
				
				d3.json(herrialdeak[hautatutako_herrialdea].datuakJSON_2, function(error, emaitzak2) {
					
					console.log(emaitzak2);
					
					if (error) return console.error(error);
					
					d3.json(herrialdeak[hautatutako_herrialdea].topoJSON, function(error, eh) {
						
						if (error) return console.error(error);
						
						// Emaitzak eta topoJSON-a bateratzeko ideia hemendik hartu dut, behar bada badago modu hobe bat.
						// http://stackoverflow.com/questions/22994316/how-to-reference-csv-alongside-geojson-for-d3-rollover
						
						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak1.udalerriak.forEach(function(d, i) {
							
							// e: Object { type="Feature",  properties={...},  geometry={...}}
							// j. indizea
							topojson.feature(eh, eh.objects[herrialdeak[hautatutako_herrialdea].json_izena]).features.forEach(function(e, j) {
								
								if (d.kodea.toString().length === 1) {
									d.kodea = "00" + d.kodea;
								} else if (d.kodea.toString().length === 2) {
									d.kodea = "0" + d.kodea;
								}
								
								if (herrialdeak[hautatutako_herrialdea].kodea + d.kodea === e.properties.ud_kodea) {
									
									// Beharrezko datuak garbitu eta prestatu.
									e.properties.emaitzak1 = d;
									
								}
							});
							
						});
						
						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak2.udalerriak.forEach(function(d, i) {
							
							// e: Object { type="Feature",  properties={...},  geometry={...}}
							// j. indizea
							topojson.feature(eh, eh.objects[herrialdeak[hautatutako_herrialdea].json_izena]).features.forEach(function(e, j) {
								
								if (d.kodea.toString().length === 1) {
									d.kodea = "00" + d.kodea;
								} else if (d.kodea.toString().length === 2) {
									d.kodea = "0" + d.kodea;
								}
								
								if (herrialdeak[hautatutako_herrialdea].kodea + d.kodea === e.properties.ud_kodea) {
									
									// Beharrezko datuak garbitu eta prestatu.
									e.properties.emaitzak2 = d;
									
								}
							});
							
						});
						
						svg.selectAll(".unitateak")
							.data(topojson.feature(eh, eh.objects[herrialdeak[hautatutako_herrialdea].json_izena]).features)
							.enter().append("path")
							.attr("fill", function(d) {
								// Herriko alderdi bozkatuenaren kolorea.
								if (d.properties.emaitzak2) {
									
									// Hautagaiarentzat kolore bat definitu badugu...
									if (alderdiak[d.properties.emaitzak2.ordena[0]]) {
										
										return alderdiak[d.properties.emaitzak2.ordena[0]].kolorea;
										
									} else {
										
										return "#cccccc";
										
									}
									
								}
								
								// Emaitzarik ez badago...
								return "#ffffff";
								
							})
							.attr("class", "unitateak")
							.attr("id", function(d) { return "unitatea_" + d.properties.ad_kod; })
							.attr("d", path)
							.on("mouseover", function(d) {
								
								d3.select("#unitatea-izena").text(d.properties.iz_euskal);
								
								beteTaula(d.properties.emaitzak1, d.properties.emaitzak2);
								
								beteDatuak(d.properties.emaitzak2);
								
							});
						
						// Eskualdeen arteko mugak (a !== b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects[herrialdeak[hautatutako_herrialdea].json_izena], function(a, b) { return a !== b; }))
							.attr("d", path)
							.attr("class", "eskualde-mugak");
						
						// Kanpo-mugak (a === b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects[herrialdeak[hautatutako_herrialdea].json_izena], function(a, b) { return a === b; }))
							.attr("d", path)
							.attr("class", "kanpo-mugak");
						
					});
					
				});
				
			});
			
			function beteTaula(datuak1, datuak2) {
				
				var katea = "";
				
				var aldea = "";
				
				var izena = "";
				
                for (var i = 0; i < datuak2.ordena.length; i++) {
                    
                    // Botoak lortu dituzten alderdiak bakarrik bistaratu.
                    if (datuak2.hautagaiak[datuak2.ordena[i]].botoak > 0) {
						
						aldea = "";
						
						for (var j = 0; j < datuak1.ordena.length; j++) {
							
							if (datuak2.hautagaiak[datuak2.ordena[i]].izena === datuak1.hautagaiak[datuak1.ordena[j]].izena) {
								
								aldea = datuak2.hautagaiak[datuak2.ordena[i]].hautetsiak - datuak1.hautagaiak[datuak1.ordena[j]].hautetsiak;
								
							}
							
							// Salbuespena: BILDU -> EH BILDU.
							if (datuak2.hautagaiak[datuak2.ordena[i]].izena === "EH BILDU" && datuak1.hautagaiak[datuak1.ordena[j]].izena === "BILDU") {
								
								aldea = datuak2.hautagaiak[datuak2.ordena[i]].hautetsiak - datuak1.hautagaiak[datuak1.ordena[j]].hautetsiak;
								
							// Salbuespena: GEROA BAI -> NA-BAI.
							} else if (datuak2.hautagaiak[datuak2.ordena[i]].izena === "GEROA BAI" && datuak1.hautagaiak[datuak1.ordena[j]].izena === "NA-BAI") {
								
								aldea = datuak2.hautagaiak[datuak2.ordena[i]].hautetsiak - datuak1.hautagaiak[datuak1.ordena[j]].hautetsiak;
								
							}
							
						}
						
						// Bi hauteskundeetako hautagaiak ez badatoz bat...
						if (aldea === "") {
							
							aldea = "-";
							
						} else if (aldea > 0) {
							
							aldea = "▲" + aldea;
							
						} else if (aldea < 0) {
							
							aldea = "▼" + Math.abs(aldea);
							
						} else {
							
							aldea = "=";
							
						}
						
						if (datuak2.ordena[i].length > 12) {
							izena = datuak2.ordena[i].substring(0, 12) + "...";
						} else {
							izena = datuak2.ordena[i];
						}
						
						// Taulako errenkada prestatu.
						// Izena luzeegia bada moztu egingo dugu.
                        katea = katea + "<tr><td class='izena' title='" + datuak2.ordena[i] + "'>" + izena + "</td><td class='botoak'>" + datuak2.hautagaiak[datuak2.ordena[i]].botoak + "</td><td class='ahulkiak'>" + datuak2.hautagaiak[datuak2.ordena[i]].hautetsiak + "</td><td class='aldea'>" + aldea + "</td></tr>";
						
                    }
						
                }
                
                $(".emaitzak-taula").html(katea);
                
			}
			
			function borobildu2dezimaletara(zenbakia) {
				
				return parseFloat(Math.round(zenbakia * 100) / 100).toFixed(2);
				
			}
			
			function beteDatuak(datuak) {
				
				$(".eguneraketa-ordua").text(datuak.ordua);
				
				$(".zenbatua").text(datuak.zenbatua);
				
				$(".errolda").text(datuak.zentsua);
				
				$(".ehuneko-abstentzioa").text(borobildu2dezimaletara(100 * datuak.abstentzioa / datuak.zentsua, 10));
				
				$(".ehuneko-baliogabeak").text(borobildu2dezimaletara(100 * datuak.baliogabeak / datuak.hautesleak));
				
				$(".ehuneko-zuriak").text(borobildu2dezimaletara(100 * datuak.zuriak / datuak.hautesleak));
				
			}
			
		</script>
	</body>
</html>
