<!doctype html>

<html>
	<head>
		<title>Euskal Herria - udalerriak</title>
		<style>
			.unitateak {
				fill: #DDDDCC;
			}

			.unitateak:hover {
				fill: #FFFF00
			}

			.eskualde-mugak {
				fill: none;
				stroke: #777;
				stroke-dasharray: 2,2;
				stroke-linejoin: round;
			}

			.kanpo-mugak {
				fill: none;
				stroke: #777;
				stroke-linejoin: round;
			}

			#kontainerra {
				margin: 0 auto 0 auto;
				width: 1000px;
			}

			#mapa {
				display: inline-block;
			}

			#datuak {
				display: inline-block;
			}

			#unitatea-izena {
				text-align: center;
			}

			#barrak {
				display: inline-block;
			}
		</style>
	</head>

	<body>
		<div id="kontainerra">
			<div id="unitatea-izena"></div>
			<div id="mapa"></div>
			<div id="barrak"></div>
		</div>

		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>

		<script>
			var width = 700,
				height = 500;

			var projection = d3.geo.mercator()
				.center([-2.2,43.0])
				.scale(9000)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("#mapa").append("svg")
				.attr("width", width)
				.attr("height", height);

			var herrialde_kodeak = {
				//"BIZKAIA": ,
				"GIPUZKOA": 20
			}

			d3.csv("datuak/MunJ11_e.csv", function(emaitzak) {

				//console.log(emaitzak);

				d3.json("udalerriak-gipuzkoa.json", function(error, eh) {

					if (error) return console.error(error);

					//console.log(eh);

					//console.log(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features);

					// Emaitzak eta topoJSON-a bateratzeko ideia hemendik hartu dut, behar bada badago modu hobe bat.
					// http://stackoverflow.com/questions/22994316/how-to-reference-csv-alongside-geojson-for-d3-rollover

					// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
					// i: indizea
					emaitzak.forEach(function(d, i) {

						if (d["TH"] === "GIPUZKOA") {

							//console.log(herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"]);

							// e: Object { type="Feature",  properties={...},  geometry={...}}
							// j. indizea
							topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features.forEach(function(e, j) {
								//console.log(e.properties.ud_kodea);
								//console.log(j);
					            if (herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"] === e.properties.ud_kodea) {
					                e.properties.emaitzak = d;
					            }
					        });

						}

				    });

					svg.selectAll(".unitateak")
						.data(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features)
						.enter().append("path")
						.attr("class", "unitateak")
						.attr("id", function(d) { return "unitatea_" + d.properties.ad_kod; })
						.attr("d", path)
						.on("mouseover", function(d) {
							//console.log(d);
							d3.select("#unitatea-izena").text(d.properties.iz_euskal + " - BILDU: " + d.properties.emaitzak["BILDU"]);
							marraztuBarrak(d.properties.emaitzak);
						});

					// Eskualdeen arteko mugak (a !== b)
					svg.append("path")
						.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a !== b; }))
						.attr("d", path)
						.attr("class", "eskualde-mugak");

					// Kanpo-mugak (a === b)
					svg.append("path")
						.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a === b; }))
						.attr("d", path)
						.attr("class", "kanpo-mugak");

				});

			});

			function marraztuBarrak(datuak) {

				d3.select("#barrak svg").remove();

				var barrak = d3.select('#barrak')
							   .append("svg")
							   .attr("width", 200)
							   .attr("height", 200);

				console.log(datuak);
				emaitzak = [{
						"BILDU": datuak["BILDU"]
					}, {
						"EAJ-PNV": datuak["EAJ-PNV"]
				    }, {
						"PSE-EE/PSOE": datuak["PSE-EE/PSOE"]
					}, {
						"PP": datuak["PP"]
					}
				];

				barrak.selectAll("rect")
			   		  .data(datuak)
			   		  .enter()
				      .append("rect")
				   	  .attr("x", 0)
				      .attr("y", 0)
				      .attr("width", 20)
				      .attr("height", 100);
			}

		</script>
	</body>
</html>
