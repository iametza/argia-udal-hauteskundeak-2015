<!doctype html>

<html>
	<head>
		<title>Euskal Herria - udalerriak</title>
		<style>
			.unitateak {
				fill: #DDDDCC;
			}

			.unitateak:hover {
				fill: #FFFF00
			}

			.eskualde-mugak {
				fill: none;
				stroke: #777;
				stroke-dasharray: 2,2;
				stroke-linejoin: round;
			}

			.kanpo-mugak {
				fill: none;
				stroke: #777;
				stroke-linejoin: round;
			}

			#kontainerra {
				margin: 0 auto 0 auto;
				width: 1000px;
				position: relative;
			}

			#mapa {
				display: inline-block;
			}

			#datuak {
				display: inline-block;
			}

			#unitatea-izena {
			    font-size: 20px;
			    font-weight: bold;
			    left: 400px;
			    position: absolute;
			    text-align: center;
			    top: 10px;
			}

			#barrak {
				display: inline-block;
			    position: absolute;
			    top: 350px;
			}
		</style>
	</head>

	<body>
		<div id="kontainerra">
			<div id="unitatea-izena"></div>
			<div id="mapa"></div>
			<div id="barrak"></div>
		</div>

		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>

		<script>
			var width = 700,
				height = 600;

			var projection = d3.geo.mercator()
				.center([-2.2,43.15])
				.scale(42000)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("#mapa").append("svg")
				.attr("width", width)
				.attr("height", height);

			var herrialde_kodeak = {
				//"BIZKAIA": ,
				"GIPUZKOA": 20
			}

			d3.csv("datuak/MunJ07_c.csv", function(emaitzak1) {

				d3.csv("datuak/MunJ11_e.csv", function(emaitzak2) {

					//console.log(emaitzak2);

					d3.json("udalerriak-gipuzkoa.json", function(error, eh) {

						if (error) return console.error(error);

						//console.log(eh);

						//console.log(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features);

						// Emaitzak eta topoJSON-a bateratzeko ideia hemendik hartu dut, behar bada badago modu hobe bat.
						// http://stackoverflow.com/questions/22994316/how-to-reference-csv-alongside-geojson-for-d3-rollover

						//console.log(emaitzak1);

						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak1.forEach(function(d, i) {

							if (d["TH"] === "GIPUZKOA") {

								//console.log(herrialde_kodeak[d["TH"]] + d["Cod.Municipio"]);

								// e: Object { type="Feature",  properties={...},  geometry={...}}
								// j. indizea
								topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features.forEach(function(e, j) {
									//console.log(e.properties.ud_kodea);
									//console.log(j);
						            if (herrialde_kodeak[d["TH"]] + d["Cod.Municipio"] === e.properties.ud_kodea) {
						                e.properties.emaitzak1 = d;
						            }
						        });

							}

					    });

						// d: Object { TH="GIPUZKOA",  Eskualde-Kodea="1",  Udalherri-Kodea="040",  gehiago...}
						// i: indizea
						emaitzak2.forEach(function(d, i) {

							if (d["TH"] === "GIPUZKOA") {

								//console.log(herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"]);

								// e: Object { type="Feature",  properties={...},  geometry={...}}
								// j. indizea
								topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features.forEach(function(e, j) {
									//console.log(e.properties.ud_kodea);
									//console.log(j);
						            if (herrialde_kodeak[d["TH"]] + d["Udalherri-Kodea"] === e.properties.ud_kodea) {
						                e.properties.emaitzak2 = d;
						            }
						        });

							}

					    });

						svg.selectAll(".unitateak")
							.data(topojson.feature(eh, eh.objects["udalerriak-gipuzkoa"]).features)
							.enter().append("path")
							.attr("class", "unitateak")
							.attr("id", function(d) { return "unitatea_" + d.properties.ad_kod; })
							.attr("d", path)
							.on("mouseover", function(d) {
								//console.log(d);
								d3.select("#unitatea-izena").text(d.properties.iz_euskal);
								marraztuBarrak(d.properties.emaitzak1, emaitzak2);
							});

						// Eskualdeen arteko mugak (a !== b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a !== b; }))
							.attr("d", path)
							.attr("class", "eskualde-mugak");

						// Kanpo-mugak (a === b)
						svg.append("path")
							.datum(topojson.mesh(eh, eh.objects["udalerriak-gipuzkoa"], function(a, b) { return a === b; }))
							.attr("d", path)
							.attr("class", "kanpo-mugak");

					});

				});

			});

			function marraztuBarrak(datuak1, datuak2) {

				d3.select("#barrak svg").remove();

				var zabalera = 300;
				var altuera = 200;
				var barPadding = 10;

				var barrak = d3.select('#barrak')
							   .append("svg")
							   .attr("width", zabalera)
							   .attr("height", altuera);

				console.log(datuak1);
				var emaitzak1 = [{
						alderdia: "EAE / ANV",
						botoak: parseInt(datuak1["EAE / ANV"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak1["EAJ-PNV"], 10)
					}, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak1["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak1["PP"], 10)
					}
				];

				//console.log(datuak2);
				var emaitzak2 = [{
						alderdia: "BILDU",
						botoak: parseInt(datuak2["BILDU"], 10)
					}, {
						alderdia: "EAJ-PNV",
						botoak: parseInt(datuak2["EAJ-PNV"], 10)
				    }, {
						alderdia: "PSE-EE/PSOE",
						botoak: parseInt(datuak2["PSE-EE/PSOE"], 10)
					}, {
						alderdia: "PP",
						botoak: parseInt(datuak2["PP"], 10)
					}
				];

				var altueraEskala = d3.scale.linear()
									.domain([0,
										 	 d3.max(emaitzak1,
													function(d) {
														return d.botoak;
													})
									])
									.range([altuera, 0]);

				barrak.selectAll("rect")
			   		  .data(emaitzak1)
			   		  .enter()
				      .append("rect")
					  .attr("x", function(d, i) {
					      return i * (zabalera / emaitzak1.length);
					  })
				      .attr("y", function(d, i) {
						  return altueraEskala(d.botoak);
					  })
				      .attr("width", zabalera / emaitzak1.length - barPadding)
					  .attr("height", function(d, i) {
					      return altuera - altueraEskala(d.botoak);
					  })
					  // Aurrerago alderdi bakoitzari bere kolorea jarri.
					  .attr("fill", "teal");

					barrak.selectAll("text")
						  .data(emaitzak1)
						  .enter()
						  .append("text")
				      	  .attr("x", function(d, i) {
						      return i * (zabalera / emaitzak1.length);
						  })
				      	  .attr("y", 0)
				      	  .attr("dy", ".75em")
				       	  .text(function(d) { return d.alderdia; });
			}

		</script>
	</body>
</html>
